---
title: "Análisis de hechos delictivos - énfasis PNC"
output: html_notebook
---

Los siguientes años seran descartados, ya que no se cuenta con una base de datos para su análisis

- 2009
- 2010
- 2013
- 2014
- 2015

Los siguiente años no cuentan con diccionario de variables, sin embargo con el archivo de tipo .sav, es posible observar las etiquetas de los datos.
- 2021
- 2024

Instalación de librerias necesarias para cargar y manipular la información, la cual se encuetra en archivos de tipo sav. Si no las tiene instalasdas en su equipo puede descomentar las primeras tres líneas.

```{r}
#install.packages("haven")
#install.packages("dplyr")
#install.packages("arules")
library(haven)
library(dplyr)
library(arules)

```




## Analisis de detenidos y victimas en el año 2011

### Cargando información
```{r}
#carga de informacion
detenidos_data_2011  <- read_sav("../data/2011/detenidos.sav")
victimas_data_2011 <- read_sav("../data/2011/victimas.sav")

detenidos_data_2012  <- read_sav("../data/2012/detenidos.sav")
victimas_data_2012 <- read_sav("../data/2012/victimas.sav")

detenidos_data_2016  <- read_sav("../data/2016/detenidos.sav")
victimas_data_2016 <- read_sav("../data/2016/victimas.sav")

detenidos_data_2017  <- read_sav("../data/2017/detenidos.sav")
victimas_data_2017 <- read_sav("../data/2017/victimas.sav")

detenidos_data_2018  <- read_sav("../data/2018/detenidos.sav")
victimas_data_2018 <- read_sav("../data/2018/victimas.sav")

detenidos_data_2019  <- read_sav("../data/2019/detenidos.sav")
victimas_data_2019 <- read_sav("../data/2019/victimas.sav")

detenidos_data_2020  <- read_sav("../data/2020/detenidos.sav")
victimas_data_2020 <- read_sav("../data/2020/victimas.sav")

detenidos_data_2021  <- read_sav("../data/2021/detenidos.sav")
victimas_data_2021 <- read_sav("../data/2021/victimas.sav")

detenidos_data_2022  <- read_sav("../data/2022/detenidos.sav")
victimas_data_2022 <- read_sav("../data/2022/victimas.sav")

detenidos_data_2023  <- read_sav("../data/2023/detenidos.sav")
victimas_data_2023 <- read_sav("../data/2023/victimas.sav")

detenidos_data_2024  <- read_sav("../data/2024/detenidos.sav")
victimas_data_2024 <- read_sav("../data/2024/victimas.sav")
```


Análisis de detenidos

1. Reglas de asociación Apriori
● Empleando el algoritmo Apriori, los estudiantes deben descubrir patrones y
relaciones interesantes entre diferentes variables en los conjuntos de datos
(mínimo 4 patrones interesantes).
● Deben identificar asociaciones significativas que puedan ayudar a
comprender mejor la problemática en cuestión y sugerir posibles
intervenciones.
● Se espera que proporcionen interpretaciones sobre el significado y la
relevancia de estas reglas de asociación para abordar la problemática
identificada.

## Arreglando información de detenidos



```{r}
#arreglando data 2011


#arreglando data 2016
detenidos_data_2016$mupio_ocu <- as.numeric(detenidos_data_2016$mupio_ocu)

fix_data_2016 <- detenidos_data_2016 %>%
  select(-menor_mayor, cód_int_Detenidos)


  
#arreglando data 2017
detenidos_data_2017$mupio_ocu <- as.numeric(detenidos_data_2017$mupio_ocu)
# Obtener las etiquetas actuales de detenidos_data_2017
labels_2017 <- attr(detenidos_data_2017$edad_quinquenales, "labels")

# Cambiar la etiqueta "80 y más" a "80 o más"
names(labels_2017)[names(labels_2017) == "80 y más"] <- "80 o más"

# Asignar las nuevas etiquetas corregidas de vuelta al dataset
attr(detenidos_data_2017$edad_quinquenales, "labels") <- labels_2017


fix_data_2017 <- detenidos_data_2017 %>%
  select(-menor_mayor) %>%
  mutate(área_geo_ocu = 0) %>%
  relocate(área_geo_ocu, .after = g_hora_mañ.tar.noch)


#arreglando data 2018

fix_data_2018 <- detenidos_data_2018 %>%
  select(-menor_mayor)

detenidos_unidos <- bind_rows(fix_data_2016, fix_data_2017)

# Comparar los valores de las etiquetas
setdiff(names(attr(detenidos_data_2016$g_delitos, "labels")), names(attr(detenidos_data_2017$g_delitos, "labels")))
setdiff(names(attr(detenidos_data_2017$g_delitos, "labels")), names(attr(detenidos_data_2016$g_delitos, "labels")))



campo <- 'hora_ocu'
attr(detenidos_data_2016[[campo]], "labels")
attr(detenidos_data_2017[[campo]], "labels")
attr(detenidos_data_2018[[campo]], "labels")
attr(detenidos_data_2019[[campo]], "labels")
attr(detenidos_data_2020[[campo]], "labels")
attr(detenidos_data_2021[[campo]], "labels")
attr(detenidos_data_2022[[campo]], "labels")
attr(detenidos_data_2023[[campo]], "labels")
attr(detenidos_data_2024[[campo]], "labels")

attr(detenidos_data_2016$hora_ocu, "labels")

str(detenidos_unidos)
str(detenidos_data_2017)

detenidos_data_2024 %>%
  select(edad_per)  %>%
  filter(edad_per == 999)

campo <- 'área_geo_ocu'
attr(victimas_data_2016[[campo]], "labels")
attr(victimas_data_2017[[campo]], "labels")
attr(victimas_data_2018[[campo]], "labels")
attr(victimas_data_2019[[campo]], "labels")
attr(victimas_data_2020[[campo]], "labels")
attr(victimas_data_2021[[campo]], "labels")
attr(victimas_data_2022[[campo]], "labels")
attr(victimas_data_2023[[campo]], "labels")
attr(victimas_data_2024[[campo]], "labels")

victimas_data_2011 %>%
  select(causas)  %>%
  distinct()

attr(victimas_data_2011$causas, "labels")
attr(victimas_data_20$delito_com, "labels")

```


```{r}
#corrigiendo etiquetas

detenidos_data_2011 <- detenidos_data_2011 %>%
  mutate(across(where(is.labelled), as.numeric))

detenidos_data_2012 <- detenidos_data_2012 %>%
  mutate(across(where(is.labelled), as.numeric))

detenidos_data_2016 <- detenidos_data_2016 %>%
  mutate(across(where(is.labelled), as.numeric))

detenidos_data_2017 <- detenidos_data_2017 %>%
  mutate(across(where(is.labelled), as.numeric))

detenidos_data_2018 <- detenidos_data_2018 %>%
  mutate(across(where(is.labelled), as.numeric))

detenidos_data_2020 <- detenidos_data_2020 %>%
  mutate(across(where(is.labelled), as.numeric))

detenidos_data_2021 <- detenidos_data_2021 %>%
  mutate(across(where(is.labelled), as.numeric))

detenidos_data_2022 <- detenidos_data_2022 %>%
  mutate(across(where(is.labelled), as.numeric))

#arreglando data 2011
fix_data_detenidos_2011 <- detenidos_data_2011 %>%
  select(-numero_corre) %>% 
  mutate(año_ocu = 2011) %>% 
  mutate(día_ocu = 99)  %>%
  rename(día_sem_ocu  = dia_sem_ocu) %>%
  mutate(hora_ocu = 99)  %>% 
  mutate(g_hora = 5)  %>% 
  mutate(g_hora_mañ.tar.noch = 4)  %>%
  rename(área_geo_ocu  = areag_ocu) %>%
  mutate(zona_ocu = 99)  %>% 
  rename(sexo_per  = sexo_dete) %>%  
  rename(edad_per  = edad_dete) %>%
  mutate(g_edad_60ymás = 12)  %>%
  mutate(g_edad_80ymás = 16)  %>%
  mutate(edad_quinquenales = 18)  %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%
  mutate(g_delitos = 9)  %>%
  rename(delito_com  = delito_infringido)


#arreglando data 2012
fix_data_detenidos_2012 <- detenidos_data_2012 %>%
  select(-numero_corre) %>% 
  mutate(año_ocu = 2012) %>% 
  rename(día_ocu = dia_ocu)  %>%
  mutate(día_sem_ocu  = 9) %>%
  mutate(hora_ocu = 99)  %>% 
  mutate(g_hora = 5)  %>% 
  mutate(g_hora_mañ.tar.noch = 4)  %>%
  rename(área_geo_ocu  = agrea_ocu) %>%
  mutate(mupio_ocu = 9)  %>% 
  mutate(zona_ocu = 99)  %>% 
  rename(sexo_per  = sexo_dete) %>%  
  rename(edad_per  = edad_dete) %>%
  mutate(g_edad_60ymás = 12)  %>%
  mutate(g_edad_80ymás = 16)  %>%
  mutate(edad_quinquenales = 18)  %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%
  mutate(g_delitos = 9)  %>%
  rename(delito_com  = causas)

#arreglando data 2016

fix_data_detenidos_2016 <- detenidos_data_2016 %>%
  select(-cód_int_Detenidos)
  
#arreglando data 2017


fix_data_detenidos_2017 <- detenidos_data_2017 %>%
  mutate(área_geo_ocu = 9) %>% 
  relocate(área_geo_ocu, .after = g_hora_mañ.tar.noch)

#arreglando data 2018
fix_data_detenidos_2018 <- detenidos_data_2018 

#arreglando data 2019
fix_data_detenidos_2019 <- detenidos_data_2019 


#arreglando data 2020

fix_data_detenidos_2020 <- detenidos_data_2020 %>%
  mutate(área_geo_ocu = 9) %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))


#arreglando data 2021

fix_data_detenidos_2021 <- detenidos_data_2021 %>%
  select(-`filter_$`) %>%
  mutate(área_geo_ocu = 9)  %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))

#arreglando data 2022
fix_data_detenidos_2022 <- detenidos_data_2022 %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))


#arreglando data 2023
fix_data_detenidos_2023 <- detenidos_data_2023 %>%
   mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))


#arreglando data 2024
fix_data_detenidos_2024 <- detenidos_data_2024 %>%
   mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))

data_detenidos <- bind_rows(
  fix_data_detenidos_2011,
  fix_data_detenidos_2012,
  fix_data_detenidos_2016, 
  fix_data_detenidos_2017,
  fix_data_detenidos_2018, 
  fix_data_detenidos_2019, 
  fix_data_detenidos_2020,
  fix_data_detenidos_2021,
  fix_data_detenidos_2022,
  fix_data_detenidos_2023,
  fix_data_detenidos_2024,
)

nrow(data_detenidos)

# Sumando las filas de los datasets que comienzan con detenidos
total_filas_detenidos <- sum(
  nrow(detenidos_data_2011),
  nrow(detenidos_data_2012),
  nrow(detenidos_data_2016),
  nrow(detenidos_data_2017),
  nrow(detenidos_data_2018),
  nrow(detenidos_data_2019),
  nrow(detenidos_data_2020),
  nrow(detenidos_data_2021),
  nrow(detenidos_data_2022),
  nrow(detenidos_data_2023),
  nrow(detenidos_data_2024)
)
total_filas_detenidos

```
Se procede a convertir las columnas a factores y aplicar apriori

```{r}
data_detenidos_format <- data_detenidos %>%
  select(-núm_corre, -edad_per, -hora_ocu) %>%
  mutate(across(
    c(año_ocu, mes_ocu, día_ocu, día_sem_ocu, g_hora, 
      g_hora_mañ.tar.noch, área_geo_ocu, depto_ocu, mupio_ocu, zona_ocu, 
      sexo_per, g_edad_60ymás, g_edad_80ymás, edad_quinquenales, 
      menor_mayor, g_delitos, delito_com), 
    as.factor  
  ))

reglas_apriori_detenidos <- apriori(data_detenidos_format, parameter = list(support = 0.2, confidence = 0.5))
  
inspect(reglas_apriori_detenidos[0:100])
reglasFrameDetenidos2 <- as(reglas_apriori_detenidos, "data.frame")
  
  
reglas_fpgrowth <- fim4r(data_detenidos_format, method ="fpgrowth", target = "rules", supp = .2, conf = .5)
reglasFrame <- as(reglas_fpgrowth, "data.frame")
```

## Arreglando información de victimas

Luego de visualizar la información, y los datos que posee, se decide que se excluira los datos de 2011 y 2011 ya que los códigos que corresponden a las causas de delitos no se manejan de la misma manera en los otros dataset, es decir tienen un código diferente lo que puede ocacionar reglas incongruentes. Si se diera el caso de analizarse se haran por separado.
#arreglando 2012

victimas_data_2012 <- victimas_data_2012 %>%
  mutate(across(where(is.labelled), as.numeric))
fix_data_victimas_2012 <- victimas_data_2012 %>%
  mutate(año_ocu = 2012) %>% 
  rename(día_ocu = dia_ocu)  %>%
  mutate(día_sem_ocu  = 9) %>%
  mutate(hora_ocu = 99)  %>% 
  mutate(g_hora = 5)  %>% 
  mutate(g_hora_mañ.tar.noch = 4)  %>%
  rename(área_geo_ocu  = areag_ocu) %>%
  mutate(zona_ocu = 99)  %>% 
  rename(sexo_per  = sexo_victima) %>%  
  rename(edad_per  = edad_victima) %>%
  mutate(g_edad_60ymás = 12)  %>%
  mutate(g_edad_80ymás = 16)  %>%
  mutate(edad_quinquenales = 18)  %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%
  mutate(g_delitos = 9)  %>%
  rename(delito_com  = causas)



```{r}
#corrigiendo etiquetas

victimas_data_2016 <- victimas_data_2016 %>%
  mutate(across(where(is.labelled), as.numeric))

victimas_data_2017 <- victimas_data_2017 %>%
  mutate(across(where(is.labelled), as.numeric))

victimas_data_2018 <- victimas_data_2018 %>%
  mutate(across(where(is.labelled), as.numeric))

victimas_data_2020 <- victimas_data_2020 %>%
  mutate(across(where(is.labelled), as.numeric))

victimas_data_2021 <- victimas_data_2021 %>%
  mutate(across(where(is.labelled), as.numeric))

victimas_data_2022 <- victimas_data_2022 %>%
  mutate(across(where(is.labelled), as.numeric))

victimas_data_2023 <- victimas_data_2023 %>%
  mutate(across(where(is.labelled), as.numeric))

victimas_data_2024 <- victimas_data_2024 %>%
  mutate(across(where(is.labelled), as.numeric))



#arreglando data 2016

fix_data_victimas_2016 <- victimas_data_2016 %>%
  select(-núm_corre_f, -hora_ocu)


#arreglando data 2017

fix_data_victimas_2017 <- victimas_data_2017 %>%
  select(-hora_ocu)  %>%
  mutate(área_geo_ocu = 9)

#arreglando data 2018
fix_data_victimas_2018 <- victimas_data_2018 %>%
  select(-hora_ocu)  %>%
  mutate(área_geo_ocu = 9)

#arreglando data 2019
fix_data_victimas_2019 <- victimas_data_2019 %>%
  select(-hora_ocu)

#arreglando data 2020
fix_data_victimas_2020 <- victimas_data_2020 %>%
  select(-hora_ocu)%>%
  mutate(área_geo_ocu = 9) %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%

#arreglando data 2021
fix_data_victimas_2021 <- victimas_data_2021 %>%
  select(-hora_ocu)%>%
  mutate(área_geo_ocu = 9) %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%

#arreglando data 2022
fix_data_victimas_2022 <- victimas_data_2022 %>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%


#arreglando data 2023
fix_data_victimas_2023 <- victimas_data_2023 %>%
  select(-hora_ocu)%>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%


#arreglando data 2024
fix_data_victimas_2024 <- victimas_data_2024 %>%
  select(-hora_ocu)%>%
  mutate(menor_mayor = case_when(
    edad_per == 999 ~ 9,
    edad_per >= 18 ~ 1,
    edad_per < 18 ~ 2
  ))  %>%


  data_victimas <- bind_rows(
  fix_data_victimas_2016, 
  fix_data_victimas_2017,
  fix_data_victimas_2018, 
  fix_data_victimas_2019,
  fix_data_victimas_2020,
  fix_data_victimas_2021,
  fix_data_victimas_2022,  
  fix_data_victimas_2023,  
  fix_data_victimas_2024
)

```

```{r}
data_victimas_format <- data_victimas %>%
  select(-núm_corre, -edad_per) %>%
  mutate(across(
    c(año_ocu, mes_ocu, día_ocu, día_sem_ocu, g_hora, 
      g_hora_mañ.tar.noch, depto_ocu, área_geo_ocu, mupio_ocu, zona_ocu, 
      sexo_per, g_edad_60ymás, g_edad_80ymás, edad_quinquenales, 
      menor_mayor, delito_com, g_delitos), 
    as.factor  
  ))


  reglas_apriori_victimas <- apriori(data_victimas_format, parameter = list(support = 0.2, confidence = 0.5))
  
  
  
  inspect(reglas_apriori_victimas[0:100])
```

